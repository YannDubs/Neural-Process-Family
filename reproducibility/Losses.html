
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criteria for LNPF &#8212; Neural Process Family</title>
    
  <link rel="stylesheet" href="../_static/css/index.d431a4ee1c1efae0e38bdfebc22debff.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.bfb7730f9caf2ec0b46a44615585038c.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-dropdown.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.30270b6e4c972e43c488.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bibliography" href="../zbibliography.html" />
    <link rel="prev" title="Convolutional Latent Neural Process (ConvLNP)" href="ConvLNP.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.gif" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Neural Process Family</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../text/Intro.html">
   The Neural Process Family
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Sub-Families
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../text/CNPF.html">
   Conditional NPF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../text/LNPF.html">
   Latent NPF
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Reproducibility
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="Datasets.html">
   Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="CNP.html">
   CNP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="AttnCNP.html">
   AttnCNP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ConvCNP.html">
   ConvCNP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="LNP.html">
   LNP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="AttnLNP.html">
   AttnLNP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ConvLNP.html">
   ConvLNP
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   LNPF Losses
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../zbibliography.html">
   Bibliography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/YannDubs/Neural-Process-Family">
   GitHub Repo
   <i class="fas fa-external-link-alt">
   </i>
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/reproducibility/Losses.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/YannDubs/Neural-Process-Family"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/YannDubs/Neural-Process-Family/master?urlpath=tree/reproducibility/Losses.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/YannDubs/Neural-Process-Family/blob/master/reproducibility/Losses.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialization">
   Initialization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training">
     Training
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plots">
     Plots
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#gps-dataset">
       GPs Dataset
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lnp">
     LNP
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#no-lower-bounds">
       No Lower bounds
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lower-bounded-std-of-latent">
       Lower bounded std of latent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lower-bounded-std-of-predictive">
       Lower bounded std of predictive
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#both-lower-bounds">
       Both Lower Bounds
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#attnlnp">
     AttnLNP
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       No Lower bounds
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Lower bounded std of latent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Lower bounded std of predictive
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Both Lower Bounds
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convlnp">
     ConvLNP
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       No Lower bounds
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Lower bounded std of latent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id7">
       Lower bounded std of predictive
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id8">
       Both Lower Bounds
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="criteria-for-lnpf">
<h1>Criteria for LNPF<a class="headerlink" href="#criteria-for-lnpf" title="Permalink to this headline">¶</a></h1>
<p>In this notebook we will investigate the inpact of using the ML or the ELBO objective for training members of LNPF.
We will also investigate the effect and/or need of using a lower bound for the standard deviation of the the latent variable and the posterior predictive.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">N_THREADS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">IS_FORCE_CPU</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Nota Bene : notebooks don&#39;t deallocate GPU memory</span>

<span class="k">if</span> <span class="n">IS_FORCE_CPU</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="n">N_THREADS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>Let’s load the data, here we will only be working with Gaussian Processes from a single underlying kernel. For more details, see the <a class="reference internal" href="Datasets.html"><span class="doc">data</span></a> notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils.ntbks_helpers</span> <span class="kn">import</span> <span class="n">get_datasets_single_gp</span>

<span class="c1"># DATASET</span>
<span class="n">gp_datasets</span><span class="p">,</span> <span class="n">gp_test_datasets</span><span class="p">,</span> <span class="n">gp_valid_datasets</span> <span class="o">=</span> <span class="n">get_datasets_single_gp</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">npf.utils.datasplit</span> <span class="kn">import</span> <span class="n">CntxtTrgtGetter</span><span class="p">,</span> <span class="n">GetRandomIndcs</span>
<span class="kn">from</span> <span class="nn">utils.data</span> <span class="kn">import</span> <span class="n">cntxt_trgt_collate</span>

<span class="c1"># CONTEXT TARGET SPLIT</span>
<span class="n">get_cntxt_trgt_1d</span> <span class="o">=</span> <span class="n">cntxt_trgt_collate</span><span class="p">(</span>
    <span class="n">CntxtTrgtGetter</span><span class="p">(</span><span class="n">contexts_getter</span><span class="o">=</span><span class="n">GetRandomIndcs</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now make the model. We will make make one model for every member of LNPF. For each we will train them with both losses, with or without lower bound on the the std of the latent distribution, and with or without lower bound on the std of the predictive distribution.
This is a total of 24 models, so we will do in a loop. Note that besides training, the same models are used as in other notebooks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">npf</span> <span class="kn">import</span> <span class="n">LNP</span><span class="p">,</span><span class="n">ConvLNP</span><span class="p">,</span> <span class="n">AttnLNP</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">npf.architectures</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CNN</span><span class="p">,</span>
    <span class="n">MLP</span><span class="p">,</span>
    <span class="n">ResConvBlock</span><span class="p">,</span>
    <span class="n">SetConv</span><span class="p">,</span>
    <span class="n">discard_ith_arg</span><span class="p">,</span>
    <span class="n">merge_flat_input</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">utils.helpers</span> <span class="kn">import</span> <span class="n">count_parameters</span>

<span class="n">R_DIM</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">XEncoder</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">),</span>
    <span class="n">Decoder</span><span class="o">=</span><span class="n">merge_flat_input</span><span class="p">(</span>  <span class="c1"># MLP takes single input but we give x and R so merge them</span>
        <span class="n">partial</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">),</span> <span class="n">is_sum_merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">r_dim</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_std_processing_kwargs</span><span class="p">(</span><span class="n">min_sigma_pred</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function returning kwarhs for processing std&quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">p_y_scale_transformer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">y_scale</span><span class="p">:</span> <span class="n">min_sigma_pred</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_sigma_pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">y_scale</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">min_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;q_z_scale_transformer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y_scale</span><span class="p">:</span> <span class="n">min_lat</span> <span class="o">+</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">min_lat</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">y_scale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">get_lnp</span><span class="p">(</span>
    <span class="n">is_mle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_sigma_pred</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">is_q_zCct</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_mle</span><span class="p">,</span>  <span class="c1"># use MLE instead of ELBO</span>
        <span class="n">n_z_samples_train</span><span class="o">=</span><span class="mi">32</span> <span class="k">if</span> <span class="n">is_mle</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># going to be more expensive</span>
        <span class="n">n_z_samples_test</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">XEncoder</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">),</span>
        <span class="n">Decoder</span><span class="o">=</span><span class="n">merge_flat_input</span><span class="p">(</span>  <span class="c1"># MLP takes single input but we give x and R so merge them</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">),</span> <span class="n">is_sum_merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">r_dim</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">,</span>
        <span class="o">**</span><span class="n">get_std_processing_kwargs</span><span class="p">(</span><span class="n">min_sigma_pred</span><span class="o">=</span><span class="n">min_sigma_pred</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="n">min_lat</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># 1D case</span>
    <span class="n">model_1d</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">LNP</span><span class="p">,</span>
        <span class="n">x_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">y_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">XYEncoder</span><span class="o">=</span><span class="n">merge_flat_input</span><span class="p">(</span>  <span class="c1"># MLP takes single input but we give x and y so merge them</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">R_DIM</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">is_sum_merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="o">**</span><span class="n">KWARGS</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model_1d</span>


<span class="k">def</span> <span class="nf">get_attnlnp</span><span class="p">(</span>
    <span class="n">is_mle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_sigma_pred</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">is_q_zCct</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_mle</span><span class="p">,</span>  <span class="c1"># use MLE instead of ELBO</span>
        <span class="n">n_z_samples_train</span><span class="o">=</span><span class="mi">8</span> <span class="k">if</span> <span class="n">is_mle</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># going to be more expensive</span>
        <span class="n">n_z_samples_test</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">r_dim</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">,</span>
        <span class="n">attention</span><span class="o">=</span><span class="s2">&quot;transformer&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">get_std_processing_kwargs</span><span class="p">(</span><span class="n">min_sigma_pred</span><span class="o">=</span><span class="n">min_sigma_pred</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="n">min_lat</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># 1D case</span>
    <span class="n">model_1d</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">AttnLNP</span><span class="p">,</span>
        <span class="n">x_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">y_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">XYEncoder</span><span class="o">=</span><span class="n">merge_flat_input</span><span class="p">(</span>  <span class="c1"># MLP takes single input but we give x and y so merge them</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">),</span> <span class="n">is_sum_merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">is_self_attn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">KWARGS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model_1d</span>


<span class="k">def</span> <span class="nf">get_convlnp</span><span class="p">(</span>
    <span class="n">is_mle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_sigma_pred</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_dim</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="n">KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">is_q_zCct</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_mle</span><span class="p">,</span>  <span class="c1"># use MLE instead of ELBO</span>
        <span class="n">n_z_samples_train</span><span class="o">=</span><span class="mi">16</span> <span class="k">if</span> <span class="n">is_mle</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># going to be more expensive</span>
        <span class="n">n_z_samples_test</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">r_dim</span><span class="o">=</span><span class="n">R_DIM</span><span class="p">,</span>
        <span class="n">Decoder</span><span class="o">=</span><span class="n">discard_ith_arg</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">),</span>  <span class="c1"># use small decoder because already went through CNN</span>
        <span class="n">z_dim</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="c1">#! NPVI requires smaller number of latent channels due to the KL</span>
        <span class="o">**</span><span class="n">get_std_processing_kwargs</span><span class="p">(</span><span class="n">min_sigma_pred</span><span class="o">=</span><span class="n">min_sigma_pred</span><span class="p">,</span> <span class="n">min_lat</span><span class="o">=</span><span class="n">min_lat</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">CNN_KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ConvBlock</span><span class="o">=</span><span class="n">ResConvBlock</span><span class="p">,</span>
        <span class="n">is_chan_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># all computations are done with channel last in our code</span>
        <span class="n">n_conv_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">n_blocks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 1D case</span>
    <span class="n">model_1d</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">ConvLNP</span><span class="p">,</span>
        <span class="n">x_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">y_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">CNN</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">CNN</span><span class="p">,</span>
            <span class="n">Conv</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">,</span>
            <span class="n">Normalization</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
            <span class="o">**</span><span class="n">CNN_KWARGS</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">density_induced</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>  <span class="c1"># size of discretization</span>
        <span class="n">is_global</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1">#! Global representation does not work well with NPVI</span>
        <span class="o">**</span><span class="n">KWARGS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model_1d</span>


<span class="n">lnpf_getters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">LNP</span><span class="o">=</span><span class="n">get_lnp</span><span class="p">,</span> <span class="n">AttnLNP</span><span class="o">=</span><span class="n">get_attnlnp</span><span class="p">,</span> <span class="n">ConvLNP</span><span class="o">=</span><span class="n">get_convlnp</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">lnpf</span><span class="p">,</span> <span class="n">is_elbo</span><span class="p">,</span> <span class="n">is_lat_LB</span><span class="p">,</span> <span class="n">is_sigma_LB</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lnpf</span><span class="si">}</span><span class="s2">_ELBO</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">is_elbo</span><span class="p">)</span><span class="si">}</span><span class="s2">_LatLB</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">is_lat_LB</span><span class="p">)</span><span class="si">}</span><span class="s2">_SigLB</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">is_sigma_LB</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">get_name</span><span class="p">(</span><span class="n">lnpf</span><span class="p">,</span> <span class="n">is_elbo</span><span class="p">,</span> <span class="n">is_lat_LB</span><span class="p">,</span> <span class="n">is_sigma_LB</span><span class="p">):</span> <span class="n">lnpf_getters</span><span class="p">[</span>
        <span class="n">lnpf</span>
    <span class="p">](</span>
        <span class="n">is_mle</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_elbo</span><span class="p">,</span>
        <span class="n">min_sigma_pred</span><span class="o">=</span><span class="mf">0.01</span> <span class="k">if</span> <span class="n">is_sigma_LB</span> <span class="k">else</span> <span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">min_lat</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">is_lat_LB</span> <span class="k">else</span> <span class="mf">1e-4</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">lnpf</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LNP&quot;</span><span class="p">,</span> <span class="s2">&quot;AttnLNP&quot;</span><span class="p">,</span> <span class="s2">&quot;ConvLNP&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">is_elbo</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">is_sigma_LB</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">is_lat_LB</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<div class="section" id="training">
<h3>Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h3>
<p>The main function for training is <code class="docutils literal notranslate"><span class="pre">train_models</span></code> which trains a dictionary of models on a dictionary of datasets and returns all the trained models.
See its docstring for possible parameters.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">skorch</span>
<span class="kn">from</span> <span class="nn">npf</span> <span class="kn">import</span> <span class="n">NLLLossLNPF</span><span class="p">,</span> <span class="n">ELBOLossLNPF</span>
<span class="kn">from</span> <span class="nn">utils.ntbks_helpers</span> <span class="kn">import</span> <span class="n">add_y_dim</span>
<span class="kn">from</span> <span class="nn">utils.train</span> <span class="kn">import</span> <span class="n">train_models</span>

<span class="n">KWARGS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">is_retrain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1">#! DEV # whether to load precomputed model or retrain</span>
    <span class="n">chckpnt_dirname</span><span class="o">=</span><span class="s2">&quot;results/pretrained/&quot;</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># use GPU if available</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">decay_lr</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># decrease learning rate by 10 during training</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
    <span class="n">test_datasets</span><span class="o">=</span><span class="n">gp_test_datasets</span><span class="p">,</span>
    <span class="n">train_split</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># No need for validation as the training data is generated on the fly</span>
    <span class="n">iterator_train__collate_fn</span><span class="o">=</span><span class="n">get_cntxt_trgt_1d</span><span class="p">,</span>
    <span class="n">iterator_valid__collate_fn</span><span class="o">=</span><span class="n">get_cntxt_trgt_1d</span><span class="p">,</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># NPVI</span>
<span class="n">trainers_1d_NPVI</span> <span class="o">=</span> <span class="n">train_models</span><span class="p">(</span>
    <span class="n">gp_datasets</span><span class="p">,</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;ELBOTrue&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">},</span>
    <span class="n">criterion</span><span class="o">=</span><span class="n">ELBOLossLNPF</span><span class="p">,</span>  <span class="c1"># NPVI</span>
    <span class="o">**</span><span class="n">KWARGS</span>
<span class="p">)</span>

<span class="c1">#NPML</span>
<span class="n">trainers_1d_NPML</span> <span class="o">=</span> <span class="n">train_models</span><span class="p">(</span>
    <span class="n">gp_datasets</span><span class="p">,</span>
    <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;ELBOTrue&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">},</span>
    <span class="n">criterion</span><span class="o">=</span><span class="n">NLLLossLNPF</span><span class="p">,</span>  <span class="c1"># NPML</span>
    <span class="o">**</span><span class="n">KWARGS</span>
<span class="p">)</span>

<span class="n">trainers_1d</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">trainers_1d_NPML</span><span class="p">,</span> <span class="o">**</span><span class="n">trainers_1d_NPVI</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Training RBF_Kernel/LNP_ELBOTrue_LatLBTrue_SigLBTrue/run_0 ---
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d27644a8318e422e966b5be3f8763ee8", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  epoch    train_loss    cp      dur
-------  ------------  ----  -------
      1      <span class=" -Color -Color-Cyan">177.9034</span>     +  99.9683
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "aa1670ea23bb479db6e7ead839f2f044", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      2      <span class=" -Color -Color-Cyan">176.0549</span>     +  103.8027
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a1bf8e70a59548b1b668710cd0e53747", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      3      <span class=" -Color -Color-Cyan">175.7554</span>     +  103.4337
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c01259154e8d45b5bfa7f155e4b27aa8", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      4      <span class=" -Color -Color-Cyan">173.0566</span>     +  103.6515
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "850c9bf76bb34c9a90309393fca6726e", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      5      <span class=" -Color -Color-Cyan">171.7896</span>     +  104.9342
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "67f3cc849859496caee11c0a889a3d53", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      7      <span class=" -Color -Color-Cyan">167.6460</span>     +  103.3266
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b83615f4581842a1a1a49e7a9e1e37cf", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      8      167.8569     +  101.0704
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5a103784f47045e888654bae88969a0d", "version_major": 2, "version_minor": 0}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IOPub message rate exceeded.
The notebook server will temporarily stop sending output
to the client in order to avoid crashing it.
To change this limit, set the config variable
`--NotebookApp.iopub_msg_rate_limit`.

Current values:
NotebookApp.iopub_msg_rate_limit=1000.0 (msgs/sec)
NotebookApp.rate_limit_window=3.0 (secs)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     11      <span class=" -Color -Color-Cyan">158.6918</span>     +  98.3054
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "508da004130b4da89ab754194543595d", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     12      <span class=" -Color -Color-Cyan">157.9744</span>     +  97.5705
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "989f7162b390431e85fc9689a1827486", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</div>
<div class="section" id="plots">
<h3>Plots<a class="headerlink" href="#plots" title="Permalink to this headline">¶</a></h3>
<p>Let’s visualize how well the model performs in different settings.</p>
<div class="section" id="gps-dataset">
<h4>GPs Dataset<a class="headerlink" href="#gps-dataset" title="Permalink to this headline">¶</a></h4>
<p>Let’s define a plotting function that we will use in this section. We’ll reuse the same function defined in <a class="reference internal" href="CNP.html"><span class="doc">CNP notebook</span></a>, but will use <code class="docutils literal notranslate"><span class="pre">n_samples</span> <span class="pre">=</span> <span class="pre">20</span></code> to plot multiple posterior predictives conditioned on different latent samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils.ntbks_helpers</span> <span class="kn">import</span> <span class="n">PRETTY_RENAMER</span><span class="p">,</span> <span class="n">plot_multi_posterior_samples_1d</span>
<span class="kn">from</span> <span class="nn">utils.visualize</span> <span class="kn">import</span> <span class="n">giffify</span>


<span class="k">def</span> <span class="nf">multi_posterior_gp_gif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">trainers</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">giffify</span><span class="p">(</span>
        <span class="n">save_filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;jupyter/gifs/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.gif&quot;</span><span class="p">,</span>
        <span class="n">gen_single_fig</span><span class="o">=</span><span class="n">plot_multi_posterior_samples_1d</span><span class="p">,</span>  <span class="c1"># core plotting</span>
        <span class="n">sweep_parameter</span><span class="o">=</span><span class="s2">&quot;n_cntxt&quot;</span><span class="p">,</span>  <span class="c1"># param over which to sweep</span>
        <span class="n">sweep_values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
        <span class="n">fps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># gif speed</span>
        <span class="c1"># PLOTTING KWARGS</span>
        <span class="n">trainers</span><span class="o">=</span><span class="n">trainers</span><span class="p">,</span>
        <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
        <span class="n">is_plot_generator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># plot underlying GP</span>
        <span class="n">is_plot_real</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># don&#39;t plot sampled / underlying function</span>
        <span class="n">is_plot_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># plot the predictive std</span>
        <span class="n">is_fill_generator_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># do not fill predictive of GP</span>
        <span class="n">pretty_renamer</span><span class="o">=</span><span class="n">PRETTY_RENAMER</span><span class="p">,</span>  <span class="c1"># pretiffy names of modulte + data</span>
        <span class="c1"># Fix formatting for coherent GIF</span>
        <span class="n">plot_config_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">set_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;legend.loc&quot;</span><span class="p">:</span> <span class="s2">&quot;upper right&quot;</span><span class="p">}</span>
        <span class="p">),</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us visualize the CNP when it is trained on samples from a single GP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">filter_npf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">lnpf</span><span class="p">,</span> <span class="n">is_elbo</span><span class="p">,</span> <span class="n">is_lat_LB</span><span class="p">,</span> <span class="n">is_sigma_LB</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select only data form single GP.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">get_name</span><span class="p">(</span><span class="n">lnpf</span><span class="p">,</span> <span class="n">is_elbo</span><span class="p">,</span> <span class="n">is_lat_LB</span><span class="p">,</span> <span class="n">is_sigma_LB</span><span class="p">)</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>

<span class="k">for</span> <span class="n">lnpf</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LNP&quot;</span><span class="p">,</span> <span class="s2">&quot;AttnLNP&quot;</span><span class="p">,</span> <span class="s2">&quot;ConvLNP&quot;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">is_sigma_LB</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">is_lat_LB</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
            <span class="n">multi_posterior_gp_gif</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;singlegp_</span><span class="si">{</span><span class="n">lnpf</span><span class="si">}</span><span class="s2">_LatLB</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">is_lat_LB</span><span class="p">)</span><span class="si">}</span><span class="s2">_SigLB</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">is_sigma_LB</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">trainers</span><span class="o">=</span><span class="n">filter_npf</span><span class="p">(</span><span class="n">trainers_1d</span><span class="p">,</span> <span class="n">lnpf</span><span class="p">,</span> <span class="n">is_elbo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_lat_LB</span><span class="o">=</span><span class="n">is_lat_LB</span><span class="p">,</span> <span class="n">is_sigma_LB</span><span class="o">=</span><span class="n">is_sigma_LB</span><span class="p">),</span>
                <span class="n">trainers_compare</span><span class="o">=</span><span class="n">filter_npf</span><span class="p">(</span><span class="n">trainers_1d</span><span class="p">,</span> <span class="n">lnpf</span><span class="p">,</span> <span class="n">is_elbo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_lat_LB</span><span class="o">=</span><span class="n">is_lat_LB</span><span class="p">,</span> <span class="n">is_sigma_LB</span><span class="o">=</span><span class="n">is_sigma_LB</span><span class="p">),</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">gp_test_datasets</span><span class="p">,</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>  <span class="c1"># 20 samples from the latent</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{model_name}</span><span class="s2"> | </span><span class="si">{data_name}</span><span class="s2"> | C=</span><span class="si">{n_cntxt}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">imgsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s now visualize all of these plots.</p>
</div>
</div>
<div class="section" id="lnp">
<h3>LNP<a class="headerlink" href="#lnp" title="Permalink to this headline">¶</a></h3>
<div class="section" id="no-lower-bounds">
<h4>No Lower bounds<a class="headerlink" href="#no-lower-bounds" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-lnp-latlbfalse-siglbfalse">
<a class="reference internal image-reference" href="../_images/singlegp_LNP_LatLBFalse_SigLBFalse.gif"><img alt="../_images/singlegp_LNP_LatLBFalse_SigLBFalse.gif" src="../_images/singlegp_LNP_LatLBFalse_SigLBFalse.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="lower-bounded-std-of-latent">
<h4>Lower bounded std of latent<a class="headerlink" href="#lower-bounded-std-of-latent" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-lnp-latlbtrue-siglbfalse">
<a class="reference internal image-reference" href="../_images/singlegp_LNP_LatLBTrue_SigLBFalse.gif"><img alt="../_images/singlegp_LNP_LatLBTrue_SigLBFalse.gif" src="../_images/singlegp_LNP_LatLBTrue_SigLBFalse.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="lower-bounded-std-of-predictive">
<h4>Lower bounded std of predictive<a class="headerlink" href="#lower-bounded-std-of-predictive" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-lnp-latlbfalse-siglbtrue">
<a class="reference internal image-reference" href="../_images/singlegp_LNP_LatLBFalse_SigLBTrue.gif"><img alt="../_images/singlegp_LNP_LatLBFalse_SigLBTrue.gif" src="../_images/singlegp_LNP_LatLBFalse_SigLBTrue.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="both-lower-bounds">
<h4>Both Lower Bounds<a class="headerlink" href="#both-lower-bounds" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-lnp-latlbtrue-siglbtrue">
<a class="reference internal image-reference" href="../_images/singlegp_LNP_LatLBTrue_SigLBTrue.gif"><img alt="../_images/singlegp_LNP_LatLBTrue_SigLBTrue.gif" src="../_images/singlegp_LNP_LatLBTrue_SigLBTrue.gif" style="width: 60em;" /></a>
</div>
</div>
</div>
<div class="section" id="attnlnp">
<h3>AttnLNP<a class="headerlink" href="#attnlnp" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>No Lower bounds<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-attnlnp-latlbfalse-siglbfalse">
<a class="reference internal image-reference" href="../_images/singlegp_AttnLNP_LatLBFalse_SigLBFalse.gif"><img alt="../_images/singlegp_AttnLNP_LatLBFalse_SigLBFalse.gif" src="../_images/singlegp_AttnLNP_LatLBFalse_SigLBFalse.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="id2">
<h4>Lower bounded std of latent<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-attnlnp-latlbtrue-siglbfalse">
<a class="reference internal image-reference" href="../_images/singlegp_AttnLNP_LatLBTrue_SigLBFalse.gif"><img alt="../_images/singlegp_AttnLNP_LatLBTrue_SigLBFalse.gif" src="../_images/singlegp_AttnLNP_LatLBTrue_SigLBFalse.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="id3">
<h4>Lower bounded std of predictive<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-attnlnp-latlbfalse-siglbtrue">
<a class="reference internal image-reference" href="../_images/singlegp_AttnLNP_LatLBFalse_SigLBTrue.gif"><img alt="../_images/singlegp_AttnLNP_LatLBFalse_SigLBTrue.gif" src="../_images/singlegp_AttnLNP_LatLBFalse_SigLBTrue.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="id4">
<h4>Both Lower Bounds<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-attnlnp-latlbtrue-siglbtrue">
<a class="reference internal image-reference" href="../_images/singlegp_AttnLNP_LatLBTrue_SigLBTrue.gif"><img alt="../_images/singlegp_AttnLNP_LatLBTrue_SigLBTrue.gif" src="../_images/singlegp_AttnLNP_LatLBTrue_SigLBTrue.gif" style="width: 60em;" /></a>
</div>
</div>
</div>
<div class="section" id="convlnp">
<h3>ConvLNP<a class="headerlink" href="#convlnp" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For NPVI to train with ConvLNP we had to remove the global representation and decrease the number of channels to <code class="docutils literal notranslate"><span class="pre">z_dim=16</span></code>.
The models for NPVI and NPML are thus slighlty different.</p>
</div>
<div class="section" id="id5">
<h4>No Lower bounds<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-convlnp-latlbfalse-siglbfalse">
<a class="reference internal image-reference" href="../_images/singlegp_ConvLNP_LatLBFalse_SigLBFalse.gif"><img alt="../_images/singlegp_ConvLNP_LatLBFalse_SigLBFalse.gif" src="../_images/singlegp_ConvLNP_LatLBFalse_SigLBFalse.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="id6">
<h4>Lower bounded std of latent<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-convlnp-latlbtrue-siglbfalse">
<a class="reference internal image-reference" href="../_images/singlegp_ConvLNP_LatLBTrue_SigLBFalse.gif"><img alt="../_images/singlegp_ConvLNP_LatLBTrue_SigLBFalse.gif" src="../_images/singlegp_ConvLNP_LatLBTrue_SigLBFalse.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="id7">
<h4>Lower bounded std of predictive<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-convlnp-latlbfalse-siglbtrue">
<a class="reference internal image-reference" href="../_images/singlegp_ConvLNP_LatLBFalse_SigLBTrue.gif"><img alt="../_images/singlegp_ConvLNP_LatLBFalse_SigLBTrue.gif" src="../_images/singlegp_ConvLNP_LatLBFalse_SigLBTrue.gif" style="width: 60em;" /></a>
</div>
</div>
<div class="section" id="id8">
<h4>Both Lower Bounds<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="figure align-default" id="singlegp-convlnp-latlbtrue-siglbtrue">
<a class="reference internal image-reference" href="../_images/singlegp_ConvLNP_LatLBTrue_SigLBTrue.gif"><img alt="../_images/singlegp_ConvLNP_LatLBTrue_SigLBTrue.gif" src="../_images/singlegp_ConvLNP_LatLBTrue_SigLBTrue.gif" style="width: 60em;" /></a>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">###### ADDITIONAL 1D PLOTS ######</span>

<span class="c1">#TO Chose</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./reproducibility"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="ConvLNP.html" title="previous page">Convolutional Latent Neural Process (ConvLNP)</a>
    <a class='right-next' id="next-link" href="../zbibliography.html" title="next page">Bibliography</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Yann Dubois, Jonathan Gordon, ‪Andrew Foong<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.30270b6e4c972e43c488.js"></script>


    
  </body>
</html>